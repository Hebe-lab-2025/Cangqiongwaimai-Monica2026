## 🆔 ID 数据库增长模式（主键生成策略｜中文面试速记）

![Image](https://towardsdatascience.com/wp-content/uploads/2024/07/15i-i8xlj8NBvHzdBTJ9VrQ.jpeg)

![Image](https://miro.medium.com/0%2A8p-O5oC8xGQrcN3D)

![Image](https://miro.medium.com/v2/resize%3Afit%3A1200/1%2AUk_poUK8O-l0ctfgecueFQ.png)

---

## 1️⃣ 为什么要关心 ID 增长模式？

ID 设计直接影响：

* 🚀 **写入性能**
* 📦 **索引效率**
* 🔁 **分库分表可扩展性**
* 🌐 **分布式系统可用性**

---

## 2️⃣ 常见 ID 增长模式总览

| 模式          | 示例               | 是否有序  | 分布式友好 | 常见场景        |
| ----------- | ---------------- | ----- | ----- | ----------- |
| 自增 ID       | 1,2,3            | ✅     | ❌     | 单库、简单系统     |
| UUID        | 550e8400…        | ❌     | ✅     | 分布式、低并发     |
| Snowflake   | 64-bit 长整型       | ✅（趋势） | ✅     | 高并发分布式      |
| 号段（Segment） | 10000–20000      | ✅     | ✅     | 业务系统        |
| 数据库序列       | sequence.nextval | ✅     | ⚠️    | Oracle / PG |
| Redis INCR  | INCR key         | ✅     | ✅     | 高并发         |

---

## 3️⃣ 各模式核心讲解（面试重点）

### ✅ 1. 自增 ID（AUTO_INCREMENT）

```sql
id BIGINT AUTO_INCREMENT
```

**特点**

* 单调递增
* InnoDB 聚簇索引友好
* 实现最简单

**缺点**

* ❌ 分库分表冲突
* ❌ ID 暴露业务规模（安全问题）
* ❌ 主从延迟/回滚问题

📌 **一句话**：单库王者，分布式地狱

---

### ✅ 2. UUID

```java
UUID.randomUUID().toString()
```

**特点**

* 全局唯一
* 不依赖中心节点

**缺点**

* ❌ 无序 → 索引碎片严重
* ❌ 占用空间大（36 字符）

📌 **优化版**：UUID v1 / v7（时间有序）

---

### ✅ 3. Snowflake（高频考点）

**64 位结构：**

```
0 | 41-bit 时间戳 | 10-bit 机器ID | 12-bit 序列号
```

**特点**

* 趋势递增
* 高并发
* 无中心节点

**风险**

* 时钟回拨
* 机器 ID 管理

📌 **一句话**：互联网公司最爱

---

### ✅ 4. 号段模式（Segment / Leaf）

**思路**

* DB 中维护一行：

```text
biz_tag | max_id | step
order   | 100000 | 1000
```

* 应用一次拉一段 ID 到内存

**优点**

* 减少 DB 压力
* ID 有序
* 稳定成熟

**缺点**

* 需要中心 DB
* 实现稍复杂

📌 **一句话**：**性能 + 稳定性** 的平衡方案

---

### ✅ 5. 数据库 Sequence

```sql
SELECT nextval('order_seq');
```

* 天生支持并发
* Oracle / PostgreSQL 常用
* MySQL 不原生支持（需模拟）

---

### ✅ 6. Redis INCR

```bash
INCR order:id
```

**特点**

* 极快
* 分布式友好

**注意**

* 需要持久化（AOF/RDB）
* Redis 宕机风险

---

## 4️⃣ 面试官最爱追问

### ❓ 为什么 UUID 不适合做 MySQL 主键？

> 因为无序，导致 B+Tree 频繁分裂，写入和查询性能差。

---

### ❓ 为什么自增 ID 在分库分表下不行？

> 因为不同库都会从 1 开始，ID 冲突，且无法全局有序。

---

### ❓ Snowflake 为什么“趋势递增”而不是严格递增？

> 因为不同机器并发生成，只有时间维度有序。

---

## 5️⃣ 选型一句话模板（直接背）

* **单体应用**：AUTO_INCREMENT
* **高并发分布式**：Snowflake
* **业务系统（稳定优先）**：号段模式
* **简单分布式**：Redis INCR
* **强唯一但低性能要求**：UUID

---

## 6️⃣ 一句话终极总结（面试金句）

> ID 设计本质是在 **有序性、唯一性、性能、分布式复杂度** 之间做权衡。

---

如果你要，我可以继续帮你：

* 🧠 **ID 模式 × B+Tree 写入过程对比图**
* 🧪 **分库分表 ID 面试题 10 连问**
* ⚔️ **Snowflake vs 号段 深度对比**
* 🔍 **时钟回拨如何解决（工程级）**

直接说哪个。
