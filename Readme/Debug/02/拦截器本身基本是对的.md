å¥½ï¼Œçœ‹åˆ°ä½ çš„æ‹¦æˆªå™¨ä»£ç äº†ï¼Œå…¶å®**æ‹¦æˆªå™¨æœ¬èº«åŸºæœ¬æ˜¯å¯¹çš„**ï¼Œç°åœ¨æœ€å¤§å«Œç–‘è¿˜æ˜¯ï¼š

> è¯·æ±‚é‡Œæ ¹æœ¬æ²¡å¸¦ä¸Šä½ æƒ³è¦çš„é‚£ä¸ª headerï¼Œæˆ–è€… header åå­—å’Œ `jwtProperties.getAdminTokenName()` å¯¹ä¸ä¸Šã€‚

æˆ‘å¸®ä½ åšä¸‰ä»¶äº‹ï¼š

1. æŒ‡å‡ºä½ æ‹¦æˆªå™¨é‡Œä¸€ä¸ªå° bugï¼ˆæ—¥å¿—å ä½ç¬¦ï¼‰
2. åŠ ä¸€æ®µ**è°ƒè¯•ä»£ç **ï¼Œç›´æ¥æ‰“å°åˆ°åº•æœ‰å“ªäº› header
3. è¯´æ˜ **yml + Swagger** åº”è¯¥æ€ä¹ˆé…ï¼Œtoken æ‰èƒ½ä¼ è¿›æ¥

---

## 1. æ‹¦æˆªå™¨å°é—®é¢˜ï¼šæ—¥å¿—å†™æ³•

ä½ ç°åœ¨è¿™ä¸€è¡Œï¼š

```java
log.info("å½“å‰å‘˜å·¥idï¼š", empId);
```

å°‘äº† `{}` å ä½ç¬¦ï¼Œåº”è¯¥æ˜¯ï¼š

```java
log.info("å½“å‰å‘˜å·¥idï¼š{}", empId);
```

ä¸æ”¹ä¹Ÿä¸å½±å“é€»è¾‘ï¼Œåªæ˜¯æ‰“å°ä¸å‡ºæ¥ idã€‚

---

## 2. å…ˆåŠ ä¸€æ®µâ€œæŸ¥çœ‹æ‰€æœ‰ headerâ€çš„è°ƒè¯•ä»£ç ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

ç°åœ¨æˆ‘ä»¬å…ˆä¸æ€€ç–‘æ‹¦æˆªå™¨ï¼Œå…ˆçœ‹çœ‹**è¯·æ±‚é‡Œåˆ°åº•æœ‰å•¥ header**ã€‚

åœ¨ `preHandle` é‡Œæ”¹æˆè¿™æ ·ï¼ˆåªå¤šäº†ä¸€ä¸ªæ‰“å°æ‰€æœ‰ header çš„ä»£ç å—ï¼‰ï¼š

```java
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    // åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº
    if (!(handler instanceof HandlerMethod)) {
        return true;
    }

    // ğŸ§ª 1. è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰ header
    System.out.println("---- Request Headers ----");
    java.util.Enumeration<String> headerNames = request.getHeaderNames();
    while (headerNames.hasMoreElements()) {
        String name = headerNames.nextElement();
        System.out.println(name + " = " + request.getHeader(name));
    }
    System.out.println("-------------------------");

    // ğŸ§ª 2. å†æ‰“å°ä¸€ä¸‹é…ç½®é‡Œçš„ header åå­—
    String headerName = jwtProperties.getAdminTokenName();
    log.info("ä»é…ç½®ä¸­è¯»å–çš„ adminTokenName = {}", headerName);

    // 1ã€ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ
    String token = request.getHeader(headerName);

    // 2ã€æ ¡éªŒä»¤ç‰Œ
    try {
        log.info("jwtæ ¡éªŒ token = {}", token);
        Claims claims = JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);
        Long empId = Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());
        log.info("å½“å‰å‘˜å·¥idï¼š{}", empId);
        BaseContext.setCurrentId(empId);
        // 3ã€é€šè¿‡ï¼Œæ”¾è¡Œ
        return true;
    } catch (Exception ex) {
        // 4ã€ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç 
        response.setStatus(401);
        return false;
    }
}
```

ç„¶åï¼š

1. **é‡å¯é¡¹ç›®**
2. ç”¨ Swagger æˆ– curl è°ƒä¸€æ¬¡ã€Œæ–°å¢å‘˜å·¥ã€
3. çœ‹æ§åˆ¶å°è¾“å‡ºï¼š

   * æœ‰æ²¡æœ‰ç±»ä¼¼ `token = eyJhbGciOiJIUzI1NiJ9...` è¿™æ ·çš„è¡Œï¼Ÿ
   * `adminTokenName` æ‰“å‡ºæ¥æ˜¯ä¸æ˜¯ä½ ä»¥ä¸ºçš„é‚£ä¸ªå€¼ï¼ˆæ¯”å¦‚ `token`ï¼‰ï¼Ÿ

> å¦‚æœæ§åˆ¶å°é‡Œæ ¹æœ¬æ²¡æœ‰ `token = xxx` è¿™ä¸€è¡Œï¼Œé‚£å°±æ˜¯è¯·æ±‚æ²¡å¸¦è¿™ä¸ª headerï¼Œæ‹¦æˆªå™¨å½“ç„¶æ‹¿ä¸åˆ°ã€‚

---

## 3. ç¡®è®¤ yml é‡Œçš„ header åï¼ˆå…³é”®ï¼‰

æ‹¦æˆªå™¨æ˜¯é€šè¿‡ `jwtProperties.getAdminTokenName()` å– header çš„ï¼Œæ‰€ä»¥ yml å¿…é¡»æœ‰è¿™ä¸€æ®µï¼ˆåå­—å¯èƒ½è·Ÿä½ ç•¥æœ‰å·®åˆ«ï¼Œå¤§è‡´æ˜¯è¿™æ ·ï¼‰ï¼š

```yaml
sky:
  jwt:
    admin-secret-key: heima
    admin-ttl: 7200000
    admin-token-name: token   # ğŸ‘ˆ è¿™ä¸ªå€¼å°±æ˜¯ header çš„åå­—
```

ğŸ‘‰ **é‡ç‚¹ï¼š**

* å¦‚æœè¿™é‡Œæ˜¯ `admin-token-name: token`ï¼Œé‚£è¯·æ±‚é‡Œå°±è¦å¸¦ï¼š
  `token: xxxxxx`
* å¦‚æœä½ å†™æˆäº† `Authorization`ï¼Œé‚£è¯·æ±‚é‡Œå°±è¦å¸¦ï¼š
  `Authorization: xxxxxx`

åªè¦ä¸¤è¾¹ä¸ä¸€è‡´ï¼Œæ‹¦æˆªå™¨å°±æ°¸è¿œæ‹¿ä¸åˆ°ã€‚

---

## 4. Swagger ä¸ºä»€ä¹ˆâ€œheader é‡Œé¢æ²¡æœ‰ tokenâ€ï¼Ÿä¸¤ç§å…¸å‹æƒ…å†µ

ä½ è¯´ï¼š

> æˆ‘åœ¨ swagger å…¨å±€å‚æ•°æ–‡æ¡£ä¸­è®¾ç½®äº† tokenï¼Œä½†æ˜¯å…·ä½“æ–¹æ³•çš„ header å“ªé‡Œæ²¡æœ‰ tokenï¼Œç°åœ¨æ‹¦æˆªå™¨ä¹Ÿæ‹¿ä¸åˆ° token

è¿™ç§ä¸€èˆ¬æœ‰ä¸¤ä¸ªå¸¸è§å‘ğŸ‘‡

---

### 4.1 åœ¨ Swagger/Knife4j UI é‡Œè®¾ç½®äº†â€œå…¨å±€å‚æ•°â€ï¼Œä½†ç±»å‹é€‰é”™ï¼ˆé€‰æˆ queryï¼‰

Knife4j çš„ UI é‡Œæœ‰**å…¨å±€å‚æ•°**çš„åŠŸèƒ½ï¼Œå¦‚æœä½ é…ç½®æ—¶ï¼š

* åç§°ï¼š`token`
* ä½ç½®ï¼š**Query**

é‚£å®ƒä¼šæŠŠ token å˜æˆï¼š`/admin/employee?page=1&token=xxxx`
è€Œä¸æ˜¯æ”¾åœ¨ header é‡Œã€‚

**ç»“æœï¼š**

* ä½ åœ¨ç•Œé¢ä¸Šæ„Ÿè§‰â€œå…¨å±€å‚æ•° OK å•Šâ€
* å®é™… HTTP è¯·æ±‚å‹æ ¹æ²¡è¿™ä¸ª header
* æ‹¦æˆªå™¨ `request.getHeader("token")` åªèƒ½æ‹¿åˆ° null

âœ… è§£å†³ï¼šç¡®è®¤ä½ åœ¨ UI ä¸ŠæŠŠå‚æ•°çš„ **in / ä½ç½®** é€‰æˆ `header`ï¼Œä¸æ˜¯ `query`ã€‚

---

### 4.2 Swagger é…ç½®ç±»é‡Œæ ¹æœ¬æ²¡çœŸæ­£å®šä¹‰â€œå…¨å±€ header å‚æ•°â€

æ›´ç¨³ã€ä¹Ÿæ›´æ¥è¿‘æ•™ç¨‹å†™æ³•çš„åšæ³•æ˜¯åœ¨ **Java çš„ Swagger é…ç½®é‡Œ**å†™ä¸€ä¸ªå…¨å±€ header å‚æ•°ã€‚

å‡è®¾ä½ æœ‰ä¸€ä¸ª `WebMvcConfiguration` æˆ– `SwaggerConfig` ç±»ï¼Œé‡Œé¢æœ‰ `docket()`ï¼Œä½ å¯ä»¥è¿™æ ·é…ï¼š

```java
@Bean
public Docket docket() {
    ApiInfo apiInfo = new ApiInfoBuilder()
            .title("è‹ç©¹å¤–å–é¡¹ç›®æ¥å£æ–‡æ¡£")
            .version("2.0")
            .description("è‹ç©¹å¤–å–é¡¹ç›®æ¥å£æ–‡æ¡£")
            .build();

    // ğŸ”¹ å®šä¹‰ä¸€ä¸ªå…¨å±€çš„ header å‚æ•°ï¼štoken
    springfox.documentation.builders.ParameterBuilder pb = new springfox.documentation.builders.ParameterBuilder();
    java.util.List<springfox.documentation.service.Parameter> params = new java.util.ArrayList<>();

    pb.name("token")                           // ğŸ‘ˆ è¿™é‡Œè¦å’Œ admin-token-name ä¸€è‡´
      .description("JWT Token")
      .modelRef(new springfox.documentation.schema.ModelRef("string"))
      .parameterType("header")                // ğŸ‘ˆ ä¸€å®šæ˜¯ header
      .required(false);
    params.add(pb.build());

    return new Docket(DocumentationType.SWAGGER_2)
            .apiInfo(apiInfo)
            .select()
            .apis(RequestHandlerSelectors.basePackage("com.sky.controller"))
            .paths(PathSelectors.any())
            .build()
            .globalOperationParameters(params);    // ğŸ‘ˆ å…³é”®ï¼šæ‰€æœ‰æ¥å£éƒ½ä¼šå¸¦ä¸Šè¿™ä¸ª header å‚æ•°
}
```

è¿™æ ·é…ç½®å®Œï¼Œé‡æ–°å¯åŠ¨ï¼š

* ç‚¹å¼€ä»»æ„æ¥å£ï¼Œæ¯”å¦‚ `/admin/employee` æ–°å¢å‘˜å·¥ï¼›
* åœ¨å‚æ•°åˆ—è¡¨é‡Œï¼Œåº”è¯¥èƒ½çœ‹åˆ°ä¸€ä¸ª header ç±»å‹çš„å‚æ•° `token`ï¼›
* åœ¨é‚£é‡Œå¡«ä¸Šç™»å½•æ¥å£è¿”å›çš„ token å€¼ï¼ŒSwagger å‘å‡ºå»çš„è¯·æ±‚æ‰ä¼šæŠŠ header å¸¦ä¸Šã€‚

---

## 5. æœ€å¿«éªŒè¯è·¯çº¿ï¼ˆå»ºè®®ä½ æŒ‰è¿™ä¸ªé¡ºåºæ¥ï¼‰

1. **åŠ ä¸Šæˆ‘ç»™ä½ çš„è°ƒè¯•æ‰“å° header é‚£æ®µä»£ç **ï¼Œé‡å¯é¡¹ç›®ã€‚
2. ç”¨ `curl` äº²è‡ªå‘ä¸€æ¬¡å¸¦ header çš„è¯·æ±‚ï¼Œçœ‹æ‹¦æˆªå™¨æ˜¯å¦èƒ½æ‹¿åˆ°ã€‚

   ```bash
   # 1) å…ˆç™»å½•æ‹¿ token
   curl -X POST "http://localhost:8080/admin/employee/login" \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"123456"}'
   ```

   å¾—åˆ°è¿”å›é‡Œçš„ `"token": "xxxxx"` åï¼Œå¤åˆ¶å‡ºæ¥ï¼š

   ```bash
   # 2) å¸¦ token è°ƒç”¨æ–°å¢å‘˜å·¥
   curl -X POST "http://localhost:8080/admin/employee" \
     -H "Content-Type: application/json" \
     -H "token: è¿™é‡Œæ¢æˆåˆšæ‰å¤åˆ¶çš„token" \
     -d '{
       "id": 0,
       "idNumber": "23",
       "name": "M",
       "phone": "",
       "sex": "",
       "username": "testUser"
     }'
   ```

   * å¦‚æœè¿™æ · **èƒ½æˆåŠŸ**ï¼Œå¹¶ä¸”æ§åˆ¶å°èƒ½çœ‹åˆ° `token = xxx`ã€`å½“å‰å‘˜å·¥id = 1`ï¼Œè¯´æ˜ï¼š

     * **æ‹¦æˆªå™¨æ²¡é—®é¢˜**
     * **yml é‡Œçš„ admin-token-name ä¹Ÿ OK**
     * çœŸæ­£æœ‰é—®é¢˜çš„æ˜¯ Swagger æ²¡æŠŠ header ä¼ è¿›æ¥ â†’ å›åˆ°ç¬¬ 4 æ­¥å»æ”¹ Swagger é…ç½®ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥ä½ å¯ä»¥ï¼š

* æŠŠ `application.yml` é‡Œ `sky.jwt` é‚£å‡ è¡Œé…ç½®å¤åˆ¶ç»™æˆ‘ï¼Œ
* å†è´´ä¸€æ®µä½ ç°åœ¨çš„ Swagger Docket é…ç½®ï¼Œ

æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ å¯¹ç€æ”¹åˆ°ã€ŒSwagger èƒ½çœ‹åˆ° header é‡Œå¸¦ç€ tokenï¼Œæ‹¦æˆªå™¨ä¹Ÿèƒ½é¡ºåˆ©æ‹¿åˆ°ã€ä¸ºæ­¢ã€‚
